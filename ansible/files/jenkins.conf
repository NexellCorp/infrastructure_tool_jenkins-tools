<VirtualHost *:80>
  ServerAdmin webmaster@localhost
  ServerName {{site_name}}
# Having >1 ServerName may cause problems with SNI, which may cause problems
# with Java 7, which in turn may cause problems with jenkins-cli.jar, which we
# want to use.
#  ServerName {{inventory_hostname}}
  ProxyRequests Off
  <Proxy *>
    Order deny,allow
    Allow from all
  </Proxy>
  ProxyPreserveHost on
  ProxyPass / http://localhost:{{jenkins_port}}/

  RewriteEngine on
  ReWriteCond %{SERVER_PORT} !^443$
  RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [NC,R,L]
</VirtualHost>

<VirtualHost *:443>
  ServerAdmin webmaster@localhost
  ServerName {{site_name}}
#  ServerName {{inventory_hostname}}
  ProxyRequests Off
  <Proxy *>
    Order deny,allow
    Allow from all
  </Proxy>

{% if hosttype == "ci" %}
  # Compatibility redirect for ci.linaro.org
  RewriteEngine on
  RewriteRule ^/jenkins/(.*) https://%{HTTP_HOST}/$1 [R,L]
{% endif %}

  # See https://wiki.jenkins-ci.org/display/JENKINS/Running+Jenkins+behind+Apache
  AllowEncodedSlashes NoDecode
  ProxyPreserveHost off
  # Note: Jenkins and Apache URL prefixes must match
  ProxyPass {{jenkins_prefix}} http://localhost:{{jenkins_port}}{{jenkins_prefix}} nocanon
  ProxyPassReverse {{jenkins_prefix}} http://localhost:{{jenkins_port}}{{jenkins_prefix}}

  SSLEngine on
  SSLCertificateFile    {{ssl_cert}}
  SSLCertificateKeyFile {{ssl_key}}
  SSLCACertificateFile /etc/ssl/certs/gd_bundle.crt
</VirtualHost>
